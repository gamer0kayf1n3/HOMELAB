{% extends "base.html" %}

{% block title %}System Stats{% endblock %}

{% block pre %}
<style>
  ul {
    list-style-type: none;
    display: flex;
    flex-direction: row;
    justify-content: space-evenly;
    align-items: stretch;
    flex-wrap: wrap;

  }

  li {
    background: #fff;
    margin: 10px 0;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    font-size: 18px;
    width: clamp(150px, 20vw, 250px);
    padding: auto 0;
    display:flex;align-items:center;justify-content:center;
  }

  .parent {
    font-size: 2.5em;
    color: #007BFF;
  }
  .parent *, .sub * {
    font-weight: bold;
    display: inline;
  }
  span {
    text-align: center;
    display: block;
  }

  .parentch {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    margin-top: 30px;
  }
  .chartparent {
    width: 30vw;
    min-width: 300px;
    margin: 10px;
  }
  @media (max-width: 800px) {
    .chartparent {
      width: 98vw;
      display: inline-block;
      margin-bottom: 20px;
    }
  }
</style>
{% endblock %}

{% block content %}
<h1>System Stats</h1>
<ul>

  <li><div>
    <span class="parent"><span id="cpu">{{ cpu }}</span>%</span>
    <span class="human">CPU Usage</span>
  </div></li>

  <li><div>
    <span class="parent"><span id="ramp">{{ percent }}</span>%</span>
    <span class="sub"><span id="ram">{{ used|round(2) }}</span> GB / <span id="ramtotal">{{ total|round(2) }}</span> GB</span>
    <span class="human">RAM Usage</span>
  </div></li>
  <li><div>
    <span class="parent"><span id="dperc">{{ dpercent }}</span>%</span>
    <span class="sub"><span id="dused">{{ dused|round(2) }}</span> GB / <span id="dtotal">{{ dtotal|round(2) }}</span> GB</span>
    <span class="human">Disk Usage</span>
  </div></li>
  <li><div>
    <span class="parent"><span id="nsent">{{ nsent|round(2) }}</span> MB</span>
    <span class="human">Network Sent</span>
  </div></li>
  <li><div>
    <span class="parent"><span id="nrecv">{{ nrecv|round(2) }}</span> MB</span>
    <span class="human">Network Received</span>
  </div></li>
</ul>

<div class="parentch">
  <div class="chartparent"><canvas id="cpuChart"></canvas></div>
  <div class="chartparent"><canvas id="ramChart"></canvas></div>
  <div class="chartparent"><canvas id="diskChart"></canvas></div>
</div>
{% endblock %}

{% block post %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const cpuCtx = document.getElementById('cpuChart').getContext('2d');
  const ramCtx = document.getElementById('ramChart').getContext('2d');
  const diskCtx = document.getElementById('diskChart').getContext('2d');

  function createChart(ctx, label, max) {
    return new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets:[{label:label, data:[], borderColor:'cyan', backgroundColor:'rgba(0,255,255,0.2)', tension:0.3}] },
      options: { animation:{duration:1000}, scales:{y:{beginAtZero:true, max:max}} }
    });
  }

  const cpuChart = createChart(cpuCtx,'CPU %',100);
  const ramChart = createChart(ramCtx,'RAM %',100);
  const diskChart = createChart(diskCtx,'Disk %',100);

  setInterval(() => {
      fetch('/stats/json', { 
          method: 'GET'
        })
        .then(function(response) { return response.json(); })
        .then(function(json) {
      console.table(json);
      document.getElementById("cpu").innerText = json["cpu"];
      document.getElementById("ram").innerText = json["ram"];
      document.getElementById("ramp").innerText = json["ramp"];
      document.getElementById("ramtotal").innerText = json["ramtotal"];
      document.getElementById("dused").innerText = json["dused"];
      document.getElementById("dtotal").innerText = json["dtotal"];
      document.getElementById("dperc").innerText = json["dperc"];
      document.getElementById("nsent").innerText = json["nsent"];
      document.getElementById("nrecv").innerText = json["nrecv"];

      const t = new Date().toLocaleTimeString();
      const cpu=json.cpu, ramp=json.ramp, disk=json.dperc;

      cpuChart.data.labels.push(t);
      cpuChart.data.datasets[0].data.push(cpu);
      ramChart.data.labels.push(t);
      ramChart.data.datasets[0].data.push(ramp);
      diskChart.data.labels.push(t);
      diskChart.data.datasets[0].data.push(disk);

      [cpuChart,ramChart,diskChart].forEach(c=>{
        if(c.data.labels.length>50){c.data.labels.shift(); c.data.datasets[0].data.shift();}
        c.update();
      });
    });
  },1000);
</script>

{% endblock %}